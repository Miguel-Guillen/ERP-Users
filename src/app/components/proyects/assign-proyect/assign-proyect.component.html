<div class="container-fluid bg-light">
    <div class="row">

        <div class="col-2 px-0">
            <app-sidebar></app-sidebar>
        </div>

        <div class="col-10 px-0">
            <div class="col pt-3 px-5" *ngIf="user.rol == 'administrador'; else noAdmin">
                <div class="row my-4">
                    <div class="col d-flex justify-content-end" *ngIf="id === '' ">
                        <input type="search" class="form-c ff rounded px-2" placeholder="buscar por nombre"
                        [(ngModel)]="search">
                        <button class="btn bg-white border border-2">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- project table -->
                <div class="h-table">
                    <div class="col vh-task ff" *ngIf="id === ''; else showProyect">
                        <h5 class="my-4 ms-3 fw-bold">Seleccione el proyecto a asignar la tarea</h5>
                        <h5 *ngIf="proyects.length == 0" class="px-3 pt-3">No hay ningun proyecto
                            añadido todavia</h5>
                        <p class="px-3" *ngIf="proyects.length == 0">
                            <a [routerLink]="['/proyect']">agregar nuevo proyecto </a>
                        <div>
                            <div class="table table-borderless border border-3 shadow my-1 
                            rounded bg-white options" type="button" (click)="getProyect(p.id)"
                            *ngFor="let p of proyects | proyects: search">
                                <div class="row my-1 p-2">
                                    <p class="col-2 text-center my-auto ff">{{p.name}}</p>
                                    <p class="col-4 my-auto ff">{{p.description}}</p>
                                    <p class="col-2 my-auto ff">{{p.area}}</p>
                                    <p class="col-1 my-auto ff"
                                    [ngClass]="{'text-danger': p.estatus == 'Cancelado',
                                    'text-success': p.estatus == 'Finalizado', 
                                    'text-info': p.estatus == 'Activo' }">{{p.estatus}}</p>
                                    <p class="col-3 my-auto text-center ff">Entrega: 
                                        {{p.dateEnd | date: format}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        
            </div>

            <div class="col px-0">
                <app-footer></app-footer>
            </div>

        </div>
    </div>
</div>

<ng-template #noAdmin>
    <div class="vh-100 p-5">
        <h1>Error pagina no encontrada</h1>
    </div>
</ng-template>

<ng-template #showProyect>
    <div class="row d-flex justify-content-around tasks mb-4">

        <div class="col-5 bg-white border border-2 shadow-sm p-3 proyect">
            <div class="card ff">
                <div class="row px-3 pt-2">
                    <div class="col">
                        <h5 class="fw-bold my-2">Proyecto: {{proyect[0].name}}</h5>
                        <p class="my-1">Descripcion: {{proyect[0].description}}</p>
                        <p class="my-1" [ngClass]="{'text-danger': proyect[0].estatus == 'Cancelado',
                        'text-success': proyect[0].estatus == 'Finalizado', 
                        'text-info': proyect[0].estatus == 'Activo' }">
                        Estado: {{proyect[0].estatus}}</p>
                    </div>
                </div>
                <div class="row px-3 d-flex align-items-center">
                    <div class="col-6">
                        <p>Tipo: {{proyect[0].type}}</p>
                        <p>Area: {{proyect[0].area}}</p>
                    </div>
                    <div class="col-6">
                        <p>Fecha de inicio: {{proyect[0].dateStart | date: format}}</p>
                        <p>Fecha de cierre: {{proyect[0].dateEnd | date: format}}</p>
                    </div>
                </div>
            </div>

            <div class="row p-2 ff proyect" *ngIf="competitors.length > 0; else noComp">
                <h5 class="my-3 fw-bold">Integrantes del proyecto</h5>
                <div>
                    <div class="col bg-light border border-3 rounded my-1 py-2" 
                    *ngFor="let c of competitors">
                        <div class="row">
                            <p class="col-2 text-center my-auto">
                                <i class="fas fa-user text-info"></i>
                            </p>
                            <p class="col-4 ff text-center my-auto">{{c.name}}</p>
                            <p class="col-4 ff text-center my-auto">{{c.rol}}</p>
                            <div class="col-1 text-center my-auto">
                                <button class="btn btn-outline-danger" data-bs-toggle="modal"
                                data-bs-target="#deleteModal" (click)="idCompetitor = c.id">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn btn-outline-success ms-1" (click)="id = '' ">Volver</button>
        </div>

        <!-- accordion -->
        <div class="col-6">
            <div class="col d-flex mx-3 mb-3 ff" *ngIf="proyect[0].estatus == 'Activo';else noTask">
                <p class="h5 my-auto fw-bold flex-grow-1">Tareas asignadas</p>
                <button class="btn btn-outline-primary me-1" data-bs-toggle="modal"
                data-bs-target="#employeeModal">Añadir participante</button>
                <button class="btn btn-outline-primary" (click)="task()">Nueva tarea</button>
            </div>
            <div class="bg-white border border-2 rounded mt-4 ff" *ngIf="tasks.length == 0">
                <h5 class="ms-3 py-3 my-auto">No hay ninguna tarea asignada al proyecto</h5>
            </div>
            <div class="accordion">
                <ngb-accordion [closeOthers]="true" activeIds="static-1" *ngIf="tasks.length > 0">
                    <ngb-panel title="{{t.title}}" *ngFor="let t of tasks">
                      <ng-template ngbPanelContent>
                            <div class="row ff">
                                <div class="col-12 mb-3 d-flex">
                                    <p class="flex-grow-1 my-auto">Titulo: {{t.title}}</p>
                                    <button class="btn btn-outline-success me-1" (click)="editTask(t.id)">Editar</button>
                                    <button class="btn btn-outline-danger" (click)="idTask = t.id"
                                    data-bs-toggle="modal" data-bs-target="#deleteTask">Borrar</button>
                                </div>
                                <div class="col-6">
                                    <p>Descripcion: {{t.description}}</p>
                                    <p>Requerimientos: {{t.requirements}}</p>
                                </div>
                                <div class="col-6">
                                    <p>Prioridad: {{t.priority}}</p>
                                    <p>Estatus: {{t.estatus}}</p>
                                    <p>Responsable: {{t.name}}</p>
                                    <p>Fecha de entrega: {{t.dueDate | date: format}}</p>
                                    <p>Diagramas o documentos {{t.images}}</p>
                                    <p>Comentarios: </p>
                                </div>
                            </div>
                      </ng-template>
                    </ngb-panel>
                </ngb-accordion>
            </div>
        </div>
        
    </div>

    <!-- Model search employee -->
    <div class="modal fade" id="employeeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-1 ff">
                        <div class="col">
                            <p>Seleccione el area de busqueda</p>
                            <div class="alert alert-danger mx-2" role="alert" *ngIf="formValid === false">
                                Datos incompletos
                            </div>
                            <p class="form-label px-3">Area</p>
                            <div class="col d-flex">
                                <select class="form-select" [(ngModel)]="area">
                                    <option value="Gestion de proyectos">Gestion de proyectos</option>
                                    <option value="Diseño de aplicaciones">Diseño de aplicaciones</option>
                                    <option value="Programacion de aplicaciones">Programacion de aplicaciones</option>
                                    <option value="Pruebas y Procesos de calidad">Pruebas y Procesos de calidad</option>
                                    <option value="contabilidad">Contabilidad</option>
                                </select>
                                <button class="btn btn-outline-success ms-1" type="button" 
                                (click)="info()">Buscar</button>
                            </div>
                            <div class="col my-2 t-employee overflow-auto">
                                <h5 class="fw-bold my-1" *ngIf="extras.length > 0">Empleados encontrados</h5>
                                <p *ngIf="extras.length > 0">Seleccione el empleado a añadir</p>
                                <div class="row bg-light border border-2 rounded" 
                                *ngFor="let e of extras" type="button" data-bs-toggle="modal" 
                                data-bs-target="#competitorModal" (click)="select(e.id, e.name, e.area, e.job)">
                                    <div class="col-6">
                                        <p class="my-1">Nombre: {{e.name}}</p>
                                        <p class="my-1">Apellidos: {{e.surnames}}</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="my-1">Area: {{e.area}}</p>
                                        <p class="my-1">Puesto: {{e.job}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger me-2" 
                    data-bs-dismiss="modal" (click)="extras = []">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Model add competitor -->
    <div class="modal fade" id="competitorModal" tabindex="-1" data-bs-backdrop="static" 
    data-bs-keyboard="false" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header ff">
                    <h5 class="modal-title text-info">Nuevo colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" 
                    aria-label="Close" (click)="reset()"></button>
                </div>
                <div class="modal-body ff px-5">
                    <form [formGroup]="competitorForm" (ngSubmit)="newCompetitor(competitorForm.value)">
                        <div class="alert alert-danger" role="alert" *ngIf="formValid === false">
                            Datos incompletos
                        </div>
                        <div class="row mb-2 ff">
                            <div class="col-6">
                                <small class="form-label">Nombre</small>
                                <input class="form-control" formControlName="name"
                                [ngClass]="{'border-bottom border-danger': formValid === false}">
                                <ng-container *ngFor="let validation of validation_messages.name">
                                    <div class="text-danger" *ngIf="competitorForm.get('name').hasError(validation.type) && 
                                    (competitorForm.get('name').dirty || competitorForm.get('name').touched)">
                                        {{validation.message}}
                                    </div>
                                </ng-container>
                            </div>
                            <div class="col-6">
                                <small class="form-label">Clave</small>
                                <input class="form-control" formControlName="idEmployee"
                                [ngClass]="{'border-bottom border-danger': formValid === false}">
                                <ng-container *ngFor="let validation of validation_messages.idEmployee">
                                    <div class="text-danger" *ngIf="competitorForm.get('idEmployee').hasError(validation.type) && 
                                    (competitorForm.get('idEmployee').dirty || competitorForm.get('idEmployee').touched)">
                                        {{validation.message}}
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                        <div class="row my-2">
                            <div class="col-6">
                                <small class="form-label">Area</small>
                                <input class="form-control" formControlName="area"
                                [ngClass]="{'border-bottom border-danger': formValid === false}">
                                <ng-container *ngFor="let validation of validation_messages.area">
                                    <div class="text-danger" *ngIf="competitorForm.get('area').hasError(validation.type) && 
                                    (competitorForm.get('area').dirty || competitorForm.get('area').touched)">
                                        {{validation.message}}
                                    </div>
                                </ng-container>
                            </div>
                            <div class="col-6">
                                <small class="form-label">Cargo</small>
                                <input class="form-control" formControlName="job"
                                [ngClass]="{'border-bottom border-danger': formValid === false}">
                                <ng-container *ngFor="let validation of validation_messages.job">
                                    <div class="text-danger" *ngIf="competitorForm.get('job').hasError(validation.type) && 
                                    (competitorForm.get('job').dirty || competitorForm.get('job').touched)">
                                        {{validation.message}}
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                        <div class="row my-3">
                            <div class="col">
                                <small class="form-label">Puesto de trabajo</small>
                                <select class="form-select" formControlName="rol"
                                [ngClass]="{'border-bottom border-danger': formValid === false}">
                                    <option value="Lider de proyecto">Lider de proyecto</option>
                                    <option value="Control de calidad">Control de calidad</option>
                                    <option value="Programador">Programador</option>
                                    <option value="Diseño">Diseño</option>
                                    <option value="Otro">Otro</option>
                                </select>
                                <ng-container *ngFor="let validation of validation_messages.rol">
                                    <div class="text-danger" *ngIf="competitorForm.get('rol').hasError(validation.type) && 
                                    (competitorForm.get('rol').dirty || competitorForm.get('rol').touched)">
                                        {{validation.message}}
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                        <div class="mt-2 float-right">
                            <button type="button" class="btn btn-outline-danger me-2" 
                            data-bs-dismiss="modal" (click)="reset()">Cancelar</button>
                            <button *ngIf="send === false; else noSend" type="button" 
                            class="btn btn-outline-primary" type="submit">Guardar cambios</button>
                            <ng-template #noSend>
                                <button class="btn btn-outline-secondary" type="button">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Guardando...
                                </button>
                            </ng-template>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal delete competitor-->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content ff">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">¿Esta seguro de borrar el participante?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Esta accion es irreversible y borrara completamente el participante del proyecto</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal"
                    (click)="deleteCompetitor()">Borrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal delete task -->
    <div class="modal fade" id="deleteTask" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content ff">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">¿Esta seguro de borrar la tarea?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Esta accion es irreversible y borrara completamente la tarea
                    asignada al proyecto</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal"
                    (click)="deleteTask()">Borrar</button>
                </div>
            </div>
        </div>
    </div>    

</ng-template>

<ng-template #noComp>
    <div class="ff">
        <h5 class="my-4">No hay integrantes en el proyecto aun</h5>
    </div>
</ng-template>

<ng-template #noTask>
    <div class="col p-2 ff">
        <h5 class="my-2 fw-bold">No se puede añadir mas tareas a este proyecto</h5>
        <p>El proyecto ha sido cerrado, para agregar mas tareas se debe volver activar
            el proyecto
        </p>
    </div>
</ng-template>